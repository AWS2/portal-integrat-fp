{% extends 'base.html' %}


{% block extra_js %}
<script type="text/javascript">
	$(document).ready(function() {
    $('#projecte').formSelect();
    $('.modal').modal();
});

function crea_qualificacio(sprint_id,equip_id) {
	$.ajax({
	  method: "GET",
	  url: "/scrum/api/crea_qualificacio/"+sprint_id+"/"+equip_id,
	  dataType: "json",
	}).done(function (resp) {
		//alert(JSON.stringify(resp));
		if ( resp.status!="OK" ) {
			alert("ERROR al modificar l'estat de la spec.");
			return;
		}
		location.reload();
	}).fail(function () {
		alert("ERROR en la creació de la qualificació de l'equip");
	});
}


function edita_qualificacio(qualificacio_id) {
	// check permissions (es fa al server)
	$.ajax({
	  method: "GET",
	  url: "{% url 'get_qualificacio' 0 %}"+qualificacio_id,
	  dataType: "json",
	}).done(function (resp) {
		if ( resp.status!="OK" ) {
			alert("ERROR accedint a la qualificació.");
			return;
		}
		var modalbox = $('#modal1 .modal-content');
		modalbox.empty();
		// construim HEADER (equip i membres)
		var equip = resp.qualificacio.equip;
		var membres_html = "";
		for(i in equip.membres) {
			membres_html += equip.membres[i].first_name+" "+
											equip.membres[i].last_name+" ("+
											equip.membres[i].email+")<br>";
		}
		var list = $('<ul class="collection with-header"></ul>');
		var header = $('<li class="collection-header">\
					<h4>'+equip.nom+'</h4>'+membres_html+'</li>');
		list.append( header );
		// construim llista de DONE SPECS
		done_specs = resp.qualificacio.done_specs;
		for(var i in done_specs) {
			var checked;
			done_specs[i].done ? checked="checked" : checked="";
			var spec = $('<li class="collection-item" >\
				<span onclick="change_done_spec('+done_specs[i].id+')" >\
				<input type="checkbox" '+checked+' id="done_spec_'+done_specs[i].id+'"/>\
				<span>'+done_specs[i].spec.nom+'</span>\
				</div></li>');
			list.append(spec);
		}
		modalbox.append(list);
	}).fail(function () {
		alert("ERROR accedint a la qualificació de l'equip. Refresca la pantalla i torna a intentar-ho.");
	});
}

function change_done_spec(done_spec_id) {
	$.ajax({
	  method: "GET",
	  url: "/scrum/api/toggle_done_spec/"+done_spec_id,
	  dataType: "json",
	}).done(function (resp) {
		if ( resp.status!="OK" ) {
			alert("ERROR al modificar l'estat de la spec.");
			return;
		}
		//alert(JSON.stringify(resp));
		var done_spec_id = resp.done_spec.id;
		var checkbox = $("#done_spec_"+done_spec_id);
		//alert(JSON.stringify(checkbox));
		checkbox.prop("checked",resp.done_spec.done);
	}).fail(function () {
		alert("ERROR en l'actualització de la spec per a la qualificació.");
	});	
}

function end_qualifica() {
	location.reload();
}

function toggle_members() {
	var elem = $(".membersbox");
	if( elem.hasClass("hide") )
		elem.removeClass("hide");
	else
		elem.addClass("hide");
}

</script>
{% endblock %}

{# carreguem filtres extra #}
{% load scrum_extras %}


{% block content %}

  <div class="container">
    <div class="section">
		<h2>Qualifica Projectes Scrum</h2>

		<form>
  		<div class="input-field col s12">
	  		<select name="projecte_id" id="projecte" onchange="submit()">
	  			<option>--- tria un projecte ---</option>
					{% for proj in projectes %}
					{% if proj.id == projecte.id %}
						<option  selected value={{proj.id}}>{{proj.nom}}</option>
					{% else %}
  					<option value={{proj.id}}>{{proj.nom}}</option>
  				{% endif %}
					{% endfor %}
				</select>
			</div>
		</form>
	  </div>

	  {% if projecte %}
    <div class="section">
			<h3>Projecte: {{projecte.nom}}</h3>
			<label>
				<input type="checkbox" checked onclick="toggle_members()" id="toggle_members" />
				<span>Mostrar/Amagar membres</span>
			</label>
			<table>
				<thead>
					<td>Equips</td>
					{% for sprint in projecte.sprints.all %}
						<td>{{sprint.nom}}</td>
					{% endfor %}
				</thead>
			{% for equip in projecte.equips.all %}
			  <tr>
			  	<td>
			  		{{equip.nom}}
			  		<div class="hide membersbox">
			  		{% for membre in equip.membres.all %}
			  		  &nbsp;&nbsp;&nbsp;&nbsp;{{membre.email}}<br>
			  		{% endfor %}
			  	  </div>
			  	</td>
				{% for sprint in projecte.sprints.all %}
					<td>
						{% if sprint.qualificacions|del_equip:equip %}
							{% for qualificacio in sprint.qualificacions|del_equip:equip %}
							  <a class="waves-effect waves-light btn modal-trigger" href="#modal1" 
						 							onclick="edita_qualificacio({{qualificacio.id}})">
						 			Edita</a><br>
								{{qualificacio.specs_completades_mps_ponderat}}
							{% endfor %}
						{% else %}
						  <a class="waves-effect waves-light btn modal-trigger" href="#" 
						 							onclick="crea_qualificacio({{sprint.id}},{{equip.id}})">Qualifica</a>
						{% endif %}
					</td>
				{% endfor %}
				</tr>
			{% endfor %}
			</table>
    </div>
    {% endif %}

  </div>


  <!-- Modal Structure -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Modal Header</h4>
      <p>A bunch of text</p>
    </div>
    <div class="modal-footer">
      <a href="#!" onclick="end_qualifica()" class="modal-close waves-effect waves-green btn-flat">Tanca</a>
    </div>
  </div>

{% endblock %}


